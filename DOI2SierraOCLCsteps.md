# Updating Sierra and OCLC Records with New DOIs

## Setup before running the first time (only need to do once)
### OCLC Connexion settings
1. Open OCLC Connexion desktop client.
2. Tools menu > Authorizations tab. Make sure a default authorization is set (required for performing batch searches).

### Install MarcEdit plugin
1. Open MarcEdit 7.
2. Plug-ins menu > Plugin Manager
3. Scroll down and select "OCLC Connexion Bib File Reader" and click Download.
4. "This plugin will be installed when MarcEdit restarts." Click OK.
5. Close Plugin Manager window and exit MarcEdit.


## Run script
1. Run DOI2SierraOCLC.py.

Required inputs:
- bepress collection setname
- bepress spreadsheet containing new DOIs.

Outputs:
- brief MARC records containing bib number, DOI fields (024, 856), and license fields (506, 540)
- searchkeys.txt containing OCLC numbers for batch search
- spreadsheet of OCLC changes for comparison/verification


## Update OCLC Records
### Get OCLC Records and Load into MarcEdit
1. Open OCLC Connexion client.
2. Cataloging menu > Search > Local Save File...
3. Make sure no search terms are entered and click OK. If the local save file is not empty, select all records (right click on a record > Select All) and delete them from the save file (Action menu > Delete Record).
4. Batch menu > Enter Bibliographic Search Keys...
5. Use default index: OCLC Number (no:)
6. Click Import..., select `searchkeys.txt`, and click Open.
7. Do you want to delete your original import file? Choose No.
8. Save and Close.
9. Batch menu > Process Batch...
10. Check the box next to the default bib local save file (DefaultBib.bib.db). Check the box next to Online Searches. Click OK and wait for batch searches to finish. Batch report should show all searches were successful.
11. Close OCLC Connexion.
12. Open MarcEdit 7.
13. Help menu > Restart MarcEdit in 32-bit Mode.
14. Open MarcEditor.
15. Plug-ins menu > OCLC Connexion Bib File Reader.
16. Click on folder icon, which should open to the location of your OCLC local save files. Select DefaultBib.bib.db and click Open.
17. Click Load File. Records in local save file appear.
18. Click Select All, then Edit Records. Wait for records to be loaded.

### Edit Records
1. All edits in this section should effect all records. If any indicate that not all records were changed, you will have to find what was missed and make the necessary change(s).
2. Edit menu > Replace
	Find: $uhttp://commons.lib.jmu.edu/
	Replace: $uhttps://doi.org/10.25885/etd/
	Click Replace All.
	Close Replace window.
3. Tools menu > Build New Field
	Pattern: =024  7\$a{856$u}$2doi
	Check box for Always add new field.
	Click Process.
	Close Build New Field window.
4. Edit menu > Replace
	Find: $ahttps://doi.org/
	Replace: $a
	Click Replace All.
	Close Replace window.
5. Tools menu > Add/Delete Field
	Field: 506
	Field Data: 0\$aJames Madison University Libraries is providing a metadata record and hyperlink to this full-text resource.$fUnrestricted online access$2star
	Uncheck box for Insert before.
	Click Add Field.
6. Still in Add/Delete Field
	Field: 506
	Field Data: 0\$aOpen access content$fOpen access content$2star
	Check box for Insert last.
	Click Add Field.
7. Still in Add/Delete Field
	Field: 540
	Field Data: \\$aThis work is licensed under a Creative Commons Attribution-NonCommercial-No Derivative Works 4.0 License.$uhttps://creativecommons.org/licenses/by-nc-nd/4.0/legalcode
	Box for Insert last is checked.
	Click Add Field.
	Click Close.
8. To save records back to OCLC, switch to the OCLC Connexion Batch Editor window. Click Save Records. If any errors occur while saving, find the OCLC number in the error message and write it down to fix later.
9. "Records have been saved." Click OK.
10. In the MarcEditor window, File menu > Save As. Save the .mrk file as setname_OCLC_edited (e.g., dnp201019_OCLC_edited.mrk).
11. Close MarcEditor window.

### Verify Changes
1. From main MarcEdit window, Tools menu > Export... > Export Tab Delimited Records.
2. Click on first folder icon, change file type to .mrk, and select the file you just saved (setname_OCLC_edited.mrk). Click Open.
3. Click on second folder icon (with green arrow), select save location, name the file, and click Save.
4. Click Next.
5. Add the following fields, clicking Add Field after each one. Subfield box is always blank.
    Field: 001
    Field: 024
    Field: 856$u
6. Normalize field data box is unchecked.
7. Click Export.
8. Open OCLC Changes.xls (generated by the script). Existing data is in columns A-D.
9. Data tab > Get External Data, From Text
10. Select text file just exported from MarcEdit and click Import.
11. Step 1: Delimited should be selected. Click Next.
12. Step 2: Tab should be checked. Click Next.
13. Step 3: With first column selected (001), change Column Data Format to Text. Click Finish.
14. Where do you want to put the data? Existing worksheet, =$E$1
15. Highlight column G (MarcEdit's 856$u). Data tab > Text to Columns
16. Select Delimited and click Next.
17. Change delimiter to Semicolon and click Finish.
18. Delete column with Proquest URLs (column H).
19. Add the following column headings:
	Col. H: 001 Check
	Col. I: 024 Check
	Col. J: 856 Check
20. Add the following formulas and fill down in each column:
	Cell H2: =EXACT(A2,E2)
	Cell I2: =EXACT(C2,F2)
	Cell J2: =EXACT(D2,G2)
21. All cells in columns H, I, and J should be TRUE. If not, figure out why and, if necessary, open OCLC Connexion and correct the record in the local save file.

### Final Updates in Connexion
1. Open OCLC Connexion. Open local save file (Cataloging menu > Search > Local Save File... Make sure no search terms are entered and click OK.)
2. Open first record in save file.
3. Edit menu > Control Headings > All
4. "One or more headings were controlled and linked. You may need to control some headings individually." Click OK.
5. LCSH and LCGFT 6XXs should be controlled, as should 1XXs and 7XXs if authority records exist for those entities. Other 655s will not control. Review record for headings that are not controlled and control if necessary (right click on field > Control Single Heading).
6. Once all headings that can be controlled are controlled, reformat (Edit menu > Reformat) and validate (Edit menu > Validate). Fix any validation errors.
7. Update master OCLC record with changes by going to Action menu > Replace Record.
8. Return to local save file and continue working through all records, controlling headings, validating, and then replacing. Delete records from local save file after replacing.


## Update Sierra Records
### Create backup of existing records
1. Select the Create Lists function in Sierra.
2. Select an empty list and click Search Records.
3. Name the review file (I usually use the setname).
4. Click Retrieve Saved Query. Select "ETDs Needing DOIs RBF" (you can click the "Query Name" column header to sort alphabetically) and click Select.
5. In line 1 of the query, Value A has "commons.lib.jmu.edu/setname". Replace "setname" with the actual setname (e.g., dnp201019), then tab or click outside of that cell.
6. Click Search and wait for query to finish running. Remember the list number.
7. Select the Data Exchange function.
8. From the dropdown menu, select "Output MARC records (out)."
9. Click Create.
10. Name the output file (setname_backup), select Review from the dropdown menu, and select the review file you just created.
11. Click Start, then click Close.
12. Select the file you just created, then click Put PC. Select a save location and click Save.
13. Find the file that was just saved and change the file extension from .out to .mrc. Open and view the file in MarcEdit to make sure it was created correctly and that all records are present.
14. In Sierra Data Exchange, select the file and click Delete.

### Load shortrecs.mrc file using Data Exchange, local load table
1. Select the Data Exchange function in Sierra.
2. From the dropdown menu, select "Load Records via a Locally Created Load Profile (local)."
3. Click Get PC, select the file of brief MARC records, and click Upload.
4. Change the suffix to .lfts and click OK.
5. Select the lfts file, click Prep, then click Start. Number of input and output records should match the number of records in the file. Click Close.
6. Click the lmarc file that was generated and click Load.
7. Select "(M) LOAD a DOI short records file (with MARC loading log)."
8. Check the box to Use Review Files.
9. Click Test. Number of input records should match the number of records in the file, and all records should overlay.
10. Click Load.
11. When load is finished, click Close.
12. Select all four files related to the brief records and click Delete.
13. Select the Create Lists function.
14. Select an empty list and click Copy.
15. Find your overlay load (it will be titled "Load: Overlaid records for filename"), select it, and click OK.
16. Do you want to remove the file being copied from? Select Yes.
17. Check some records to make sure that DOI fields (024, 856) and license fields (two 506s, 540) have been added and are correct. The DOI fields should match the end of the existing Scholarly Commons URL, and the new 856 should have been added as the first 856 field.

### Remove Scholarly Commons URLs
1. Remember the number of the Create List containing the records that have been updated with DOIs.
2. Select the Global Update function in Sierra.
3. Record Type: Bibliographic should be checked. Change Index to Review, select your list, and click Search. A list of the records will appear.
4. Select step 2. Command input.
5. Select Delete variable-length field and click OK.
6. Uncheck the box Use Displayed Field. Enter "856" in the MARC Tag box, and "commons.lib.jmu.edu" in the Data box. Click OK.
7. Select step 3. Preview. All records should show the 856 with "commons.lib.jmu.edu" being deleted.
8. Click Process.
9. Return to Create Lists and check a few records.
10. Empty the list.
